<html lang="en">
<head>
	<title>Browser Activity Monitor</title>
	<script>
		function load(){
      var username = localStorage.getItem("userName");
      if (username == null) username == "";
			document.getElementById("username").value = username;
      var secret = localStorage.getItem("secret");
      if (secret == null) secret = "";
      document.getElementById("secret").value = secret;
			var isAnonymous = localStorage.getItem("isAnonymous");
			if(isAnonymous == "yes"){
				document.getElementById("encode").innerHTML="URL Encoding: ON";
			}
			if(localStorage.pause){
				document.getElementById("toggle").innerHTML="Status: OFF";
			}
		}
		
		function getSecret(){
			var username = document.getElementById("username").value;
      var users = localStorage.getItem("users");
      if (username in users){
        document.getElementById("secret") = users[username];
      }
      else{
        document.getElementById("secret") = chrome.extension.getBackgroundPage().generateSecret();
      }
      
		}
		
		function save(){
			var username = document.getElementById("username").value;
			var secret = document.getElementById("secret").value;
      var users = JSON.parse(localStorage.getItem("users"));
			if (username == null) username = "default";
      if (users != null){
          /*If there is no provided secret check to see if the user already
          * exists, if they do just use the stored secret otherwise make
          * a new one. */
          if (secret == ""){
            if (username in users){
              secret = users[username];
            } else {
              secret = chrome.extension.getBackgroundPage().generateSecret();
              users[username] = secret;
            }
          } else {
            users[username] = secret;
          }
      } else{
          users = {};
          users[username] =  secret;
      }
		  localStorage.setItem("userName", username);
			localStorage.setItem("secret", secret);
      localStorage.setItem("users", JSON.stringify(users));
		}
		
		function encode(){
			var isAnonymous = localStorage.getItem("isAnonymous");
			if (isAnonymous == "yes"){
				document.getElementById("encode").innerHTML="URL Encoding: OFF";
				localStorage.setItem("isAnonymous", "no");
			} else{
				document.getElementById("encode").innerHTML="URL Encoding: ON";
				localStorage.setItem("isAnonymous", "yes");
			}
		}
		
		function toggle(){
      if(!localStorage.pause){
        localStorage.pause="true";
        document.getElementById("toggle").innerHTML="Status: OFF";         
      }else if(localStorage.pause){
         localStorage.pause="";
         document.getElementById("toggle").innerHTML="Status: ON";
      }
		}
		
		function show(){
      chrome.extension.getBackgroundPage().showstat();
		}
		
		function reset(){
      var userName=localStorage.getItem("userName");
      var secret=localStorage.getItem("secret");
      var isDebug=localStorage.getItem("isDebugMode");
      var isAnonymous=localStorage.getItem("isAnonymous");
      var users = localStorage.getItem("users");
      var pause=localStorage.pause;
      localStorage.clear();
      localStorage.wasCleared=true;
      var clearTime=new Date().getTime();
      localStorage.clearTime=clearTime;
      localStorage.setItem("userName",userName);
      localStorage.setItem("secret", secret);
      localStorage.setItem("users", users);
      localStorage.isDebugMode=isDebug;
      localStorage.isAnonymous=isAnonymous;
      localStorage.pause=pause;
		}
	</script>
</head>
<body onload = "load()">
	<h3>Browser Activity Monitor</h3>
		Username: <input type="text" id="username"/>
		Secret: <input type="text" id="secret" onclick="getSecret()"/>
		<button type="buttpn" onclick="save()">Save</button>
		<button type="button" id="encode" onclick="encode()">URL Encoding: OFF</button>
		<button type="button" id="toggle" onclick="toggle()">Status: ON</button>
		<button type="button" onclick="show()">Show tracking information</button>
		<button type="button" onclick="reset()">Clear history</button>
</body>
</html>
